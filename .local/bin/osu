#!/bin/sh
export WINEARCH=win32
mkdir -p "$HOME/.local/share/wineprefixes/"
export WINEPREFIX="$HOME/.local/share/wineprefixes/osu"
export WINEDEBUG=-all

#export PULSE_LATENCY_MSEC=25
# export PULSE_LATENCY_MSEC=20

winebindir=/opt/wine-osu/bin

if [ -z "$PATH" ]; then
  PATH="$winebindir"
else
  PATH="$winebindir:$PATH"
fi

if [ -z "$LD_LIBRARY_PATH" ]; then
  LD_LIBRARY_PATH="$winebindir/../lib64:$winebindir/../lib:$winebindir/../lib32"
else
  LD_LIBRARY_PATH="$winebindir/../lib64:$winebindir/../lib:$winebindir/../lib32:$LD_LIBRARY_PATH"
fi

# append dll paths to WINEDLLPATH

appendwinepath() {
        case ":$WINEDLLPATH:" in
                *:"$1":*)
                        ;;
                *)
                        WINEDLLPATH="${WINEDLLPATH:+$WINEDLLPATH:}$1"
        esac
}

appendwinepath '/usr/lib/discord-rpc-wine/i686/'

unset appendwinepath
export WINEDLLPATH

## Uncomment the following line to always use the dll override
## This might break some games as not everything is implemented in this discord-rpc implementation
export WINEDLLOVERRIDES="${WINEDLLOVERRIDES:+$WINEDLLOVERRIDES;}discord-rpc=b"

function doinstall {
    echo "Installing osu!"
    echo

    if [ -d "$HOME/.osu" ]
    then
        while true
        do
            read -p "$HOME/.osu exists, would you like to move it to $WINEPREFIX? (Will assume that the wineprefix is configured correctly) [Y/n] " yn
            case $yn in
            ""|[Yy]* )
            rm -r "$WINEPREFIX" &>/dev/null
            mv "$HOME/.osu" "$WINEPREFIX"
            /opt/osu/osulauncher & exit;;
            [Nn]* ) break;;
            * ) echo "Please answer y or n.";;
            esac
        done
    fi
    # maybe this should test $XDG_DATA_HOME?
    if [ -f "$HOME/.local/share/applications/wine-extension-osz.desktop" ]
    then
        sed -i "s:$HOME/.osu:$WINEPREFIX:" "$HOME/.local/share/applications/wine-extension-*.desktop"
    fi

    echo "Creating wineprefix..."
    echo "Do NOT install Mono (press cancel)!"
    WINEDLLOVERRIDES='mscoree=' wine hh || exit 1
    echo "Wineprefix created successfully!"
    echo "Installing .NET 4.5"
    if [ -z "$(which winetricks)" ]
    then
        echo "Installation failed. Please install winetricks."
        read
        exit 1
    fi
    winetricks dotnet45 || (doremove && exit 1)
    echo ".NET 4.5 installed successfully!"
    echo
    echo "Applying some settings..."
    winetricks fontsmooth=rgb strictdrawordering=enabled
    #regedit /opt/osu/directsound-latency.reg
    echo "All done! Running osu! updater..."
    sleep 1
    #cp "/opt/osu/game/osu!install.exe" "$WINEPREFIX/osu!install.exe"
    #wine "$WINEPREFIX/osu!install.exe"
}

function doinstalloptional {
    if [ ! -d "$WINEPREFIX" ]
    then
        doinstall
    fi

    echo "Installing optional dependencies for osu!"
    echo

    winetricks gdiplus corefonts cjkfonts
}

function doremove {
    echo "Removing wineprefix..."
    rm -rf "$WINEPREFIX"
}


case "$1" in
"install")
 doinstall
 exit 0
 ;;

"install-optional")
 doinstalloptional
 exit 0
 ;;

"remove")
 doremove
 exit 0
 ;;

"reinstall")
 doremove
 doinstall
 exit 0
 ;;

"gosu")
 app="$WINEPREFIX/drive_c/users/$USER/Local Settings/Application Data/osu!/gosumemory/gosumemory.exe"
 ;;

"winetricks")
 shift
 winetricks $@
 exit 0
 ;;
"run")
 app=$2
 shift 2
 ;;
"tournament")
 #desktop="explorer /desktop=osu-tournament,1920x1080"
 gamemode="gamemoderun"
 app="$WINEPREFIX/drive_c/users/$USER/Local Settings/Application Data/tournament/osu!.exe"
 ;;
"showcase")
 gamemode="gamemoderun"
 app="$WINEPREFIX/drive_c/users/$USER/Local Settings/Application Data/tournament2/osu!.exe"
 ;;
"notitg")
 gamemode="gamemoderun"
 #wine /opt/wine-discord-ipc-bridge/winediscordipcbridge.exe &
 app="$WINEPREFIX/drive_c/users/$USER/Local Settings/Application Data/NotITG/Program/NotITG-v4.2.0.exe"
 ;;
#"trainer")
 #desktop="explorer /desktop=osu-tournament,1920x1080"
 #gamemode="gamemoderun"
 #app="$WINEPREFIX/drive_c/users/$USER/Local Settings/Application Data/osu!/osu-trainer/osu-trainer.exe"
 #;;
"discord-rpc")
 app="/opt/wine-discord-ipc-bridge/winediscordipcbridge.exe"
 ;;
*)
 #gamemode="gamemoderun"
 wine /opt/wine-discord-ipc-bridge/winediscordipcbridge.exe &
 app="$WINEPREFIX/drive_c/users/$USER/Local Settings/Application Data/osu!/osu!.exe"
 ;;
esac

if [ ! -d "$WINEPREFIX" ]
then
    doinstall
    exit 0
fi


# sudo /archive/games/osu\!/Overlay/Effects/gosu/gosumemory 2> /dev/null &
# wine /archive/games/osu\!/Overlay/Effects/gosu/win/gosumemory.exe 2> /dev/null &
vblank_mode=0 __GL_SYNC_TO_VBLANK=0 exec $gamemode wine $desktop "$app" $@ #2> /dev/null
vblank_mode=0 __GL_SYNC_TO_VBLANK=0 exec $gamemode wine $desktop "$app" $@ #2> /dev/null
